<!DOCTYPE html><html><head><meta charset="utf-8"><title>CJDI Radius</title><style></style></head><body id="preview">
<h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="Introduction_0"></a>Introduction</h1>
<p class="has-line-data" data-line-start="2" data-line-end="3">The intent of this sample code is to show how to use CASR/CJDI radius as a library from a non OSGi environment. In this context, the sample provides a radius server applications based on SpringBoot, which provides a CJDI radius server proxylet defined without OSGi.</p>
<h1 class="code-line" data-line-start=4 data-line-end=5 ><a id="Prerequisites_4"></a>Prerequisites</h1>
<p class="has-line-data" data-line-start="5" data-line-end="6">Maven must be installed</p>
<h1 class="code-line" data-line-start=7 data-line-end=8 ><a id="Architecture_7"></a>Architecture</h1>
<p class="has-line-data" data-line-start="8" data-line-end="9">SpringBoot support the concept of “starters”. a SpringBoot starter allows to embed in your springboot application the necessary dependencies for a given feature by simply adding one maven dependeny in your pom (or you gradle) project. For example, if your application needs to support REST services, you would add this single dependency in your application:</p>
<pre><code class="has-line-data" data-line-start="11" data-line-end="16" class="language-sh">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p class="has-line-data" data-line-start="16" data-line-end="17">Similarly, to be able to use CJDI radius in a springboot application and embed all the necessary CASR/CJDI dependencies, you also need to declare a CJDI starter. But before declaring such starter, you must first create one. To do so, we provide a maven “archetype” which you can use to generate your own CJDI radius starter.</p>
<p class="has-line-data" data-line-start="18" data-line-end="19">A Maven archetype is a kind of template that is deployed to artifactory and it can be used to bootstrap a new maven (or gradle, anything actually) project from scratch.</p>
<p class="has-line-data" data-line-start="20" data-line-end="21">So, you need to run the archetype command by passing some arguments which will tell what CJDI components must be included in your CJDI starter. Indeed, CJDI is component based and we don’t provide a mega jar; instead you must select the features you want and a CJDI OSGi runtime is then generated with the features you have selected. For example, for the support of Radius, you would select the following features:</p>
<ul>
<li class="has-line-data" data-line-start="22" data-line-end="23">lib.log.log4j:1.0.0: this feature adds support for log4j 1.2 (use lib.log.log4j:2.0.0 for log4j 2.0 API)</li>
<li class="has-line-data" data-line-start="23" data-line-end="24">runtime.felix.embedded: this feature regroups the dependencies for Apache Felix OSGi framework</li>
<li class="has-line-data" data-line-start="24" data-line-end="25">ioh.mux.radius: this feature regroups the dependencies for the CJDI Radius IO Handler</li>
<li class="has-line-data" data-line-start="25" data-line-end="27">agent.proxylet.radius: this feature regroups the dependencies for the CJDI Radius Proxylet Engine.</li>
</ul>
<p class="has-line-data" data-line-start="27" data-line-end="30">More features could be added like for example the support of Prometheus metrics, CSF/Kafka CSF/Service Discovery (etcd4j), etc …<br>
For the moment, let’s use the minimal features (felix +  radius ioh + radius proxylet engine).<br>
So, once you have created your CJDI starter, you can then embed it in your springboot application.</p>
<p class="has-line-data" data-line-start="31" data-line-end="32">One more thing must be described before going ahead: It mus tbe explained how to interact with the CJDI OSGi runtime. This is done using CJDI “OSGi bridge” service, which allows you to obtain OSGi services from springboot class loader, and/or register your proxylets from springboot to CJDI OSGi Runtime. The interface for this service looks like the following:</p>
<pre><code class="has-line-data" data-line-start="33" data-line-end="40" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OsgiLauncher</span> </span>{
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">ServiceRegistration&lt;T&gt; <span class="hljs-title">registerService</span><span class="hljs-params">(Class&lt;T&gt; service, T implementation)</span></span>;
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">CompletableFuture&lt;T&gt; <span class="hljs-title">getService</span><span class="hljs-params">(Class&lt;T&gt; service)</span></span>;
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">CompletableFuture&lt;T&gt; <span class="hljs-title">getService</span><span class="hljs-params">(Class&lt;T&gt; service, String filter)</span></span>;
    ...
}
</code></pre>
<p class="has-line-data" data-line-start="41" data-line-end="42">Now, when your springboot application defines a dependency on the CJDI springboot starter, it is then able to be injected with the OsgiLauncher “bridge” service. Here is an example of a springboot REST controler which is getting the CJDI RadiusClientFactory osgi service using the OsgiLauncher service:</p>
<pre><code class="has-line-data" data-line-start="44" data-line-end="63" class="language-java"><span class="hljs-annotation">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiameterLoaderController</span> </span>{

    <span class="hljs-comment">/**
     * This service is the bridge between springboot world and CJDI osgi world.
     * Using this service, you can then obtain CASR services, or register your
     * springboot classes as osgi services.
     */</span>
    <span class="hljs-annotation">@Autowired</span>
    <span class="hljs-keyword">private</span> OsgiLauncher _launcher;
    
        <span class="hljs-annotation">@RequestMapping</span>(<span class="hljs-string">"/start"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{
        CompletableFuture&lt;DiameterClientFactory&gt; dcf = _launcher.getService(DiameterClientFactory.class);
        RadiusClientFactory factory = dfc.get(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
        ...
    }
}
</code></pre>
<h1 class="code-line" data-line-start=63 data-line-end=64 ><a id="Creating_a_CJDI_SpringBoot_starter_63"></a>Creating a CJDI SpringBoot starter</h1>
<p class="has-line-data" data-line-start="64" data-line-end="65">Now, let’s  create your CJDI springboot starter. To do so, you must invoke the CJDI springboot starter archtetype:</p>
<pre><code class="has-line-data" data-line-start="66" data-line-end="77" class="language-sh">mvn <span class="hljs-operator">-s</span> settings.xml archetype:generate -U  -B \
    -Dobr=http://repo.lab.pl.alcatel-lucent.com/csf-mvn-delivered/com/nokia/casr/com.nokia.casr.obr/<span class="hljs-number">19.9</span>.<span class="hljs-number">2</span>/com.nokia.casr.obr-<span class="hljs-number">19.9</span>.<span class="hljs-number">2</span>.xml \
    -DarchetypeGroupId=com.nokia.casr \
    -DarchetypeArtifactId=com.nokia.as.archetype.springboot.starter \
    -DarchetypeCatalog=<span class="hljs-built_in">local</span> \
    -DarchetypeVersion=<span class="hljs-number">1.0</span>.<span class="hljs-number">8</span> \
    -DgroupId=com.nokia.casr.samples.radius.springboot \
    -DartifactId=com.nokia.casr.samples.radius.springboot.starter \
    -Dversion=<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span> \
    -Dfeatures=runtime.felix.embedded,ioh.mux.radius,agent.proxylet.radius,lib.log.log4j:<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>
</code></pre>
<p class="has-line-data" data-line-start="77" data-line-end="78">So, in the above command, you have specified the G.A.V for your new starter as well as the needed CJDI features:</p>
<ul>
<li class="has-line-data" data-line-start="78" data-line-end="79">-DgroupId=com.nokia.casr.samples.radius.springboot: this is the group id of the CJDI starter you are creating</li>
<li class="has-line-data" data-line-start="79" data-line-end="80">-DartifactId=com.nokia.casr.samples.radius.springboot.starter: this is the artifactId of the CJDI starter you are creating</li>
<li class="has-line-data" data-line-start="80" data-line-end="81">-Dversion=1.0.0: this is the version of the CJDI starter you are creating</li>
<li class="has-line-data" data-line-start="81" data-line-end="83">-Dfeatures=runtime.felix.embedded,ioh.mux.radius,agent.proxylet.radius,lib.log.log4j:1.0.0: this is the CJDI minimal features for support of radius</li>
</ul>
<h1 class="code-line" data-line-start=83 data-line-end=84 ><a id="Build_the_generated_CJDI_starter_83"></a>Build the generated CJDI starter</h1>
<p class="has-line-data" data-line-start="84" data-line-end="85">now we have generated the CJDI starter, let’s build it:</p>
<pre><code class="has-line-data" data-line-start="86" data-line-end="89" class="language-sh"><span class="hljs-built_in">cd</span> com.nokia.casr.samples.radius.springboot.starter
mvn <span class="hljs-operator">-s</span> ../settings.xml clean dependency:copy install
</code></pre>
<p class="has-line-data" data-line-start="89" data-line-end="90">Notice that the ‘dependency:copy’ option is needed because we need to embed in the target starter jar all the CJDI dependencies.</p>
<h1 class="code-line" data-line-start=91 data-line-end=92 ><a id="Build_the_springboot_sample_server_91"></a>Build the springboot sample server</h1>
<p class="has-line-data" data-line-start="92" data-line-end="94">Now we have generated and built our CJDI starter, we can now build the springboot radius server.<br>
The server pom is already importing the CJDI starter we have generated:</p>
<pre><code class="has-line-data" data-line-start="96" data-line-end="102" class="language-sh">        &lt;dependency&gt;
            &lt;groupId&gt;com.nokia.casr.samples.radius.springboot&lt;/groupId&gt;
            &lt;artifactId&gt;com.nokia.casr.samples.radius.springboot.starter&lt;/artifactId&gt;
            &lt;version&gt;<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<p class="has-line-data" data-line-start="102" data-line-end="103">So, now let’s build the server:</p>
<pre><code class="has-line-data" data-line-start="104" data-line-end="107" class="language-sh"><span class="hljs-built_in">cd</span> com.nokia.casr.samples.radius.springboot.server
mvn <span class="hljs-operator">-s</span> ../settings.xml clean install
</code></pre>
<h1 class="code-line" data-line-start=107 data-line-end=108 ><a id="Start_the_diameter_server_107"></a>Start the diameter server</h1>
<p class="has-line-data" data-line-start="108" data-line-end="110">The configuration is already pre configured in the ./conf directory.<br>
So, you can now start the server like this:</p>
<pre><code class="has-line-data" data-line-start="111" data-line-end="114" class="language-sh"><span class="hljs-built_in">cd</span> com.nokia.casr.samples.radius.springboot.server
java -D<span class="hljs-built_in">log</span>4j.ignoreTCL=<span class="hljs-literal">true</span> -D<span class="hljs-built_in">log</span>4j.configuration=file:conf/<span class="hljs-built_in">log</span>4j.properties -Das.config.file.confdir=conf -jar target/com.nokia.casr.samples.radius.springboot.server-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>.jar
</code></pre>
<p class="has-line-data" data-line-start="114" data-line-end="115">Notice the following:</p>
<ul>
<li class="has-line-data" data-line-start="115" data-line-end="116">-Das.config.file.confdir that is passed as argument: it must point the CJDI configuration directory.</li>
<li class="has-line-data" data-line-start="116" data-line-end="117">-Dlog4j.ignoreTCL: this property must be set to true in order to ignore the thread class loader when log4j is loading classes from within the embdded OSGI container</li>
<li class="has-line-data" data-line-start="117" data-line-end="119">-Dlog4j.configuration: must point to the log4j configuration.</li>
</ul>
<p class="has-line-data" data-line-start="119" data-line-end="120">Internal CJDI diameter container logs are genereted to stdout (see conf/log4j.properties file)</p>
<p class="has-line-data" data-line-start="121" data-line-end="122">Interesting configuration files are:</p>
<ul>
<li class="has-line-data" data-line-start="123" data-line-end="124">conf/log4j.properties: used to configure log4j)</li>
<li class="has-line-data" data-line-start="124" data-line-end="125">conf/radius-pxlets.xml: used to declare your diameter proxylet (TestAccessRequestProxylet)</li>
</ul>

</body></html>